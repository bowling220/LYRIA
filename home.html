<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>LYRIA Chat - Home</title>
        
        <!-- Meta Tags for Educational Purpose -->
        <meta name="description" content="LYRIA Chat is an educational platform designed to facilitate communication and collaboration among students and educators.">
        <meta name="keywords" content="education, chat, communication, students, teachers, learning, collaboration">
        <meta name="author" content="Bowling220 & TurquoiseBrush">
        <meta name="robots" content="index, follow">
        <meta name="theme-color" content="#5865f2">
        <link rel="preconnect" href="https://www.gstatic.com">
        <link rel="dns-prefetch" href="https://cdn.agora.io">
        <link rel="preload" href="assets/icon.png" as="image">
    
        <link rel="stylesheet" href="css/main.css">
        
        <!-- Firebase SDKs -->
        <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
        
        <!-- Utility Scripts -->
        <script src="js/config.js"></script>
        <script src="js/utils.js"></script>
        <script src="js/performance.js"></script>
        
        <!-- PeerJS and Agora RTC SDK -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.3.1/peerjs.min.js"></script>
        <script src="https://cdn.agora.io/sdk/release/AgoraRTC_N.js"></script>
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9049091067762501" crossorigin="anonymous"></script>

       <style>
            /* Background Options */
            #background-options {
                display: flex; /* Use flexbox for layout */
                justify-content: space-around; /* Space out the images */
                flex-wrap: wrap; /* Allow wrapping to the next line if needed */
                margin-top: 10px; /* Space above the options */
            }

            .background-option {
                cursor: pointer; /* Pointer cursor on hover */
                width: 50px; /* Smaller width for thumbnails */
                height: auto; /* Maintain aspect ratio */
                border: 2px solid transparent; /* Default border */
                transition: border-color 0.3s; /* Transition for border color */
            }

            .background-option:hover {
                border-color: #5865f2; /* Highlight border on hover */
            }
            .centered-heading {
    text-align: center; /* Centers the heading */
}

.info-text {
    color: rgb(255, 0, 0); /* White color for the information part */
    background-color: #1e272e; /* Dark background to make it stand out */
    padding: 5px 10px; /* Add padding to make it feel more like a tag */
    border-radius: 5px; /* Slightly rounded corners for a soft look */
    font-size: 1rem; /* Slightly smaller font size to differentiate */
    margin-left: 10px; /* Space it out from the main heading */
    display: inline-block; /* Keep it inline with the heading */
}

/* Maintenance Overlay Styling */
.maintenance-overlay {
    position: fixed; /* Cover the entire screen */
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8); /* Semi-transparent background */
    color: white; /* Text color */
    display: flex;
    flex-direction: column;
    justify-content: center; /* Center vertically */
    align-items: center; /* Center horizontally */
    z-index: 1000; /* Ensure it is on top of other content */
}

        </style>
    </head>
<body>


    <!-- Mobile Experience Message -->
    <div id="mobile-message" style="display: none; background-color: #ffcccb; padding: 10px; text-align: center; position: sticky; top: 0; z-index: 1000;">
        For a better experience, please use a computer.
        <button id="close-mobile-message" style="margin-left: 10px; background-color: #f44336; color: white; border: none; cursor: pointer;">
            Close
        </button>
    </div>

    <header class="top-header">
        <button class="menu-toggle" id="header-menu-toggle" aria-label="Toggle navigation menu" aria-expanded="false">‚ò∞</button>
        <h1 style="flex: 1; text-align: center; margin: 0; font-size: 1.2rem;">LYRIA Chat</h1>
    </header>
    <div class="app-container">
        <div class="sidebar">
            <div class="channels">
                <h3 class="centered-heading">Channels<span class="info-text">You Might Need To Refresh Once, If More Please Let Me Know!</span></h3>
                <ul class="channels-list" id="channels-list"></ul>
                <button class="add-channel-btn" id="add-channel">Add Channel</button>
                <button class="join-channel-btn" id="join-channel">Join Channel</button>
                <button class="leave-channel-btn" id="leave-channel">Leave Channel</button>



            </div>
            <button class="join-channel-btn" id="news-feed-button" onclick="window.location.href='News.html'">News Feed <span style="background: #ff4444; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.8rem;">NEW</span></button>


            <!-- Button to open Friends Modal -->
            <button id="open-friends-modal" class="action-btn">Open Friends</button>

            <!-- Friends Modal -->
            <div id="friends-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="friends-modal-title">
                <div class="modal-content">
                    <button id="close-friends-modal" class="close-button" aria-label="Close Friends Modal">&times;</button>
                    <h2 id="friends-modal-title">Friends</h2>
                    <ul class="friends-list" id="friends-list">
                        Add Some Friends!
                    </ul>
                    <div class="set-status">
                        <h4>Set Your Status</h4>
                        <select id="status-select">
                            <option value="">Select Status</option>
                            <option value="available">Available</option>
                            <option value="busy">Busy</option>
                            <option value="away">Away</option>
                        </select>
                        <button id="update-status-btn" class="action-btn">Update Status</button>
                    </div>
                </div>
            </div>

            <!-- Suggestions Section -->
            <div class="suggestions-section">
                <h3>Suggestions</h3>
                <p>We value your feedback! Please share your suggestions for new features or improvements.</p>
                <button id="open-suggestions-modal" class="suggestions-link">Submit Your Suggestions</button>
            </div>

            <div class="user-profile">
                <img class="avatar" id="user-avatar" src="assets/icon.png" alt="User avatar">
                <span class="username" id="user-name">User</span>
                <button class="settings-btn" id="settings-btn">Settings</button>
            </div>

        </div>
        <main class="chat-area">
            <header class="chat-header">
                <h2 id="channel-title"># general</h2>
                <button id="copy-join-code" class="copy-join-code-btn">Invite Others</button>
                <button id="inbox-btn" onclick="window.location.href='inbox.html'" style="background: none; border: none; color: var(--text-color); cursor: pointer; padding: 8px; font-size: 1.2rem;">
                    üì¨ Inbox <span id="friend-request-count" style="background: red; color: white; padding: 2px 6px; border-radius: 50%; font-size: 0.8rem; display: none;">1</span>
                </button>
            </header>
            <div class="messages" id="messages"></div>
            <!-- Typing Status Indicator -->
            <div id="typing-status" class="typing-status" style="display: none;"></div>
            <div class="message-input">
                <textarea id="message-input" placeholder="Message #" style="height: 15px;"></textarea>
                <button id="send-button" class="send-btn" style="background-color: rgba(255, 255, 255, 0.2); color: rgb(0, 0, 0); border: 1px solid rgba(255, 255, 255, 0.4); padding: 6px 12px; font-size: 14px; cursor: pointer; border-radius: 8px; backdrop-filter: blur(4px); margin-right: 100px;">
                    Send
                </button>
            </div>
        </main>
    </div>
    <div id="profile-modal" class="modal">
        <div class="modal-backdrop"></div>
        <div class="modal-content" style="background-image: url('assets/default-background.jpg'); background-size: cover; background-position: center;">
            <img id="profile-modal-image" src="assets/icon.png" alt="User Avatar">
            <h2 id="profile-modal-name">User Name</h2>
            <div id="profile-modal-badges" class="badges-container"></div>
            <p id="profile-modal-bio" style="color: #1E90FF;">COMING SOON</p>
            <button id="send-friend-request" class="action-btn">Send Friend Request</button>
            <button id="close-profile-modal" class="close-button">√ó</button>
        </div>
    </div>
<div id="version-info" style="position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); color: var(--text-color); font-size: 12px; font-weight: bold; text-shadow: 1px 1px 2px var(--background-color);">
    Version: 5.0.1 &copy; 2024 LYRIA. All rights reserved. Trademarked by LYRIA.
</div>
<!-- Settings Modal -->
<div id="settings-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="settings-modal-title">
    <div class="modal-content">
        <button id="close-modal" class="close-button" aria-label="Close Settings Modal">&times;</button>
        <h2 id="settings-modal-title">Settings</h2>
        
        <!-- Toggle Dark Mode -->
        <div class="modal-section">
            <button id="toggle-dark-mode" class="action-btn">Toggle Dark Mode</button>
        </div>
        
        <!-- Update Profile Image -->
        <div class="modal-section">
            <label for="profile-image-input" class="modal-label">Update Profile Image:</label>
            <input type="file" id="profile-image-input" class="modal-input" accept="image/*" disabled>
            <button id="update-profile-image" class="action-btn" disabled>Update Image (Premium)</button>
            <p class="premium-info" style="color: #ffcc00;">Premium users can change their profile picture.</p>
        </div>

      

        <!-- Upgrade to Premium Section -->
        <div class="modal-section">
            <button id="upgrade-to-premium" class="action-btn upgrade-btn">üëë Upgrade to Premium</button>
            <p style="color: #ffcc00;">Unlock premium features by upgrading your account!</p>
        </div>

        <!-- Update Display Name -->
        <div class="modal-section">
            <label for="display-name-input" class="modal-label">Update Display Name:</label>
            <input type="text" id="display-name-input" class="modal-input" placeholder="Enter new display name">
            <button id="update-display-name" class="action-btn">Update Name</button>
        </div>
        
        <!-- Update Bio Section -->
        <div class="modal-section">
            <label for="bio-input" class="modal-label">Update Bio:</label>
            <input type="text" id="bio-input" class="modal-input" placeholder="Enter your bio">
            <button id="update-bio-btn" class="action-btn">Update Bio</button>
        </div>
        
        <!-- Enable Notifications -->
        <div class="modal-section">
            <label class="toggle-switch">
                <input type="checkbox" id="notifications-toggle">
                <span class="slider"></span>
                Enable Notifications
            </label>
        </div>
        
        <!-- Toggle Badge Visibility (only visible if user has the admin badge) -->
        <div class="modal-section" id="badge-visibility-section" style="display: none;">
            <label class="toggle-switch">
                <input type="checkbox" id="badge-visibility-toggle">
                <span class="slider"></span>
                Show Badges
            </label>
        </div>
        
        <!-- Logout Button -->
        <div class="modal-section">
            <button id="logout-btn" class="action-btn logout-btn">Logout</button>
        </div>
    </div>
</div>

    <!-- Include voiceCall.js before chat.js -->
    <script src="voiceCall.js"></script>
    <script src="chat.js"></script>

    <!-- Firebase initialization check -->
    <script>
        // Wait for Firebase to be initialized before using it
        function waitForFirebase() {
            if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
                // Firebase is ready, initialize the rest of the app
                console.log('Firebase initialized, starting home page...');
            } else {
                // Wait and try again
                setTimeout(waitForFirebase, 100);
            }
        }

        // Start waiting for Firebase
        waitForFirebase();
    </script>

    <script>
        function changeBackground(image) {
            document.body.style.backgroundImage = `url(${image})`;
        }

        function changeProfileImage(image) {
            const profileModalImage = document.getElementById('profile-modal-image');
            profileModalImage.src = image; // Update the profile image

            const currentUser = firebase.auth().currentUser;
            if (currentUser) {
                // Update Firestore with the new background image
                db.collection('users').doc(currentUser.uid).update({
                    backgroundImage: image
                }).then(() => {
                    console.log('Background image updated successfully!');
                }).catch((error) => {
                    console.error('Error updating background image:', error);
                });
            }
        }

        // Detect if the user is on a mobile device
        function isMobileDevice() {
            return /Mobi|Android|iPhone|iPad|iPod|Windows Phone/i.test(navigator.userAgent);
        }

        // Display the mobile message if on a mobile device
        window.addEventListener('load', () => {
            const mobileMessage = document.getElementById('mobile-message');
            if (isMobileDevice()) {
                mobileMessage.style.display = 'block';
            }

            // Load last visited channel from localStorage
            const lastChannel = localStorage.getItem('lastVisitedChannel');
            if (lastChannel) {
                // Update channel title and load messages for last visited channel
                document.getElementById('channel-title').textContent = `# ${lastChannel}`;
                // Assuming you have a function to load channel messages
                loadChannelMessages(lastChannel);
            }
        });

        // Close the mobile message
        document.getElementById('close-mobile-message').addEventListener('click', () => {
            const mobileMessage = document.getElementById('mobile-message');
            mobileMessage.style.display = 'none';
        });

        // Assuming you have already initialized Firebase and authenticated the user
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                const userId = user.uid;

                // Wait for Firebase to be ready before using db
                function waitForDb() {
                    if (typeof db !== 'undefined') {
                        // Fetch user data from Firestore
                        db.collection('users').doc(userId).get().then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        document.getElementById('user-name').textContent = userData.displayName;
                        document.getElementById('user-avatar').src = userData.photoURL || 'assets/icon.png';

                        // Set initial values for settings
                        document.getElementById('notifications-toggle').checked = userData.notificationsEnabled || false;
                        document.getElementById('bio-input').value = 'COMING SOON';
                        document.getElementById('profile-modal-bio').textContent = 'COMING SOON';

                        // Set dark mode based on user preference
                        if (userData.darkMode) {
                            document.body.classList.add('dark-mode');
                        }

                        // Load friends
                        loadFriends(userId);
                        
                        // Check for friend requests
                        checkFriendRequests(userId);

                        // Check if user is premium and unlock features
                        if (userData.isPremium) {
                            // Enable premium features
                            document.getElementById('profile-image-input').disabled = false;
                            document.getElementById('update-profile-image').disabled = false;
                            document.getElementById('bio-input').disabled = false;
                            document.getElementById('update-bio-btn').disabled = false;
                        }
                    } else {
                        console.log("No such document!");
                    }
                        }).catch(error => {
                            console.error("Error getting document:", error);
                        });

                    } else {
                        // db is not ready yet, wait and try again
                        setTimeout(waitForDb, 100);
                    }
                }

                // Check if the user is the one to be banned
                if (userId === '') {
                    // Disable the News Feed button
                    const newsButton = document.getElementById('news-feed-button');
                    if (newsButton) {
                        newsButton.disabled = true;
                        newsButton.style.cursor = 'not-allowed';
                        newsButton.title = 'Access to News Feed is restricted.';
                    }
                }

                // Start waiting for db to be ready
                waitForDb();
            }
        });

        // Function to check for friend requests
        function checkFriendRequests(userId) {
            db.collection('friendRequests')
                .where('to', '==', userId)
                .onSnapshot(snapshot => {
                    const requestCount = snapshot.docs.length;
                    const countElement = document.getElementById('friend-request-count');
                    if (requestCount > 0) {
                        countElement.style.display = 'inline';
                        countElement.textContent = requestCount;
                    } else {
                        countElement.style.display = 'none';
                    }
                });
        }

        // Function to remove friend
        async function removeFriend(friendId) {
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) return;

            try {
                // Remove friend from current user's friends list
                await db.collection('users').doc(currentUser.uid).update({
                    friends: firebase.firestore.FieldValue.arrayRemove(friendId)
                });

                // Remove current user from friend's friends list
                await db.collection('users').doc(friendId).update({
                    friends: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
                });

                // Reload friends list
                loadFriends(currentUser.uid);
            } catch (error) {
                console.error('Error removing friend:', error);
                alert('Failed to remove friend. Please try again.');
            }
        }

        // Function to load friends with images and names
        async function loadFriends(userId) {
            const friendsList = document.getElementById('friends-list');
            friendsList.innerHTML = ''; // Clear previous content

            try {
                // Get the current user's document
                const userDoc = await db.collection('users').doc(userId).get();

                if (userDoc.exists) {
                    const userData = userDoc.data();
                    const friends = userData.friends || []; // Get the friends array

                    if (friends.length === 0) {
                        friendsList.innerHTML = '<li>No friends added yet.</li>';
                        return;
                    }

                    // Loop through each friend's ID
                    for (const friendId of friends) {
                        // Fetch friend's details from the users collection
                        const friendDoc = await db.collection('users').doc(friendId).get();
                        if (friendDoc.exists) {
                            const friendData = friendDoc.data();
                            const friendName = friendData.displayName || 'Unknown Friend';
                            const friendAvatar = friendData.photoURL || 'default-avatar.png';
                            const friendStatus = friendData.status || 'No status set';

                            // Determine status color based on the status text
                            let statusColor;
                            if (friendStatus.toLowerCase() === 'available') {
                                statusColor = 'green';
                            } else if (friendStatus.toLowerCase() === 'busy') {
                                statusColor = 'red';
                            } else if (friendStatus.toLowerCase() === 'away') {
                                statusColor = 'orange';
                            } else {
                                statusColor = 'gray'; // Default color for unknown status
                            }

                            // Add the friend's information to the list with remove button
                            const listItem = document.createElement('li');
                            listItem.innerHTML = `
                                <img src="${friendAvatar}" alt="${friendName}" class="friend-avatar">
                                <span class="friend-name">${friendName}</span>
                                <span class="friend-status" style="display: inline-block; width: 10px; height: 10px; background-color: ${statusColor}; border-radius: 50%; margin-left: 10px; margin-right: 5px;"></span>
                                <button onclick="removeFriend('${friendId}')" class="remove-friend-btn" style="margin-left: auto; background: none; border: none; color: #ff4444; cursor: pointer;">
                                    ‚ùå
                                </button>
                            `;
                            listItem.style.display = 'flex';
                            listItem.style.alignItems = 'center';
                            listItem.style.justifyContent = 'space-between';
                            friendsList.appendChild(listItem);
                        }
                    }
                } else {
                    friendsList.innerHTML = '<li>No user data found.</li>';
                }
            } catch (error) {
                console.error('Error loading friends:', error);
                friendsList.innerHTML = '<li>Failed to load friends.</li>';
            }
        }

        async function acceptFriendRequest(requestId) {
            const requestDoc = await db.collection('friendRequests').doc(requestId).get();
            if (requestDoc.exists) {
                const requestData = requestDoc.data();  
                const currentUser = firebase.auth().currentUser;

                // Update both users' friends arrays
                await db.collection('users').doc(currentUser.uid).update({
                    friends: firebase.firestore.FieldValue.arrayUnion(requestData.from)
                });
                await db.collection('users').doc(requestData.from).update({
                    friends: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                });

                // Remove the friend request
                await db.collection('friendRequests').doc(requestId).delete();

                alert('Friend request accepted!');
            }
        }

        // Add event listener for profile image update
        document.getElementById('update-profile-image').addEventListener('click', async () => {
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) return;

            const fileInput = document.getElementById('profile-image-input');
            const file = fileInput.files[0];

            if (file) {
                // Show confirmation modal
                document.getElementById('confirm-image-change-modal').style.display = 'block';
            } else {
                alert('Please select an image file first.');
            }
        });

        // Add event listener for the upgrade to premium button
        document.getElementById('upgrade-to-premium').addEventListener('click', () => {
            // Redirect to a payment page or show a modal for payment options
            window.location.href = 'premium-upgrade.html'; // Replace with your actual upgrade page
        });

        // Save current channel before leaving
        window.addEventListener('beforeunload', () => {
            const currentChannel = document.getElementById('channel-title').textContent.replace('# ', '');
            localStorage.setItem('lastVisitedChannel', currentChannel);
        });

        let isDragging = false;
        let startX;
        let sidebar = document.querySelector('.sidebar');

        const sidebarToggle = document.getElementById('sidebar-menu-toggle');
        if (sidebarToggle) {
            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('open');
            });
        }

        // Remove all dragging logic

        function submitSuggestion(articleId) {
            const suggestionInput = document.getElementById(`suggestion-input-${articleId.split('-')[1]}`);
            const suggestionText = suggestionInput.value;

            if (suggestionText.trim() !== '') {
                const suggestionList = document.getElementById(`suggestion-list-${articleId.split('-')[1]}`);
                const suggestionElement = document.createElement('div');
                suggestionElement.className = 'comment';
                suggestionElement.innerText = suggestionText;

                suggestionList.appendChild(suggestionElement);
                suggestionInput.value = ''; // Clear the input after submitting

                // Optionally, save the suggestion to Firestore
                const suggestionRef = doc(db, 'suggestions', articleId);
                setDoc(suggestionRef, { suggestion: suggestionText }, { merge: true });
            }
        }

        // Add this after your existing Firebase initialization
        const GIPHY_API_KEY = 'hVCy8PF3vcOo65OlFeniKs2e4pvsjO3W'; // Replace with your Giphy API key
        const GIF_COOLDOWN = 30000; // 30 seconds cooldown between GIFs
        let lastGifTime = 0;

        document.addEventListener('DOMContentLoaded', () => {
            const gifButton = document.getElementById('gif-button');
            const gifModal = document.getElementById('gif-modal');
            const closeGifModal = document.getElementById('close-gif-modal');
            const gifSearch = document.getElementById('gif-search');
            const gifResults = document.getElementById('gif-results');

            if (gifButton && gifModal) {
                gifButton.addEventListener('click', () => {
                    gifModal.style.display = 'block';
                    searchGifs('trending');
                });
            }

            if (closeGifModal) {
                closeGifModal.addEventListener('click', () => {
                    gifModal.style.display = 'none';
                });
            }

            if (gifSearch) {
                gifSearch.addEventListener('input', debounce((e) => {
                    const query = e.target.value.trim();
                    if (query) {
                        searchGifs(query);
                    } else {
                        searchGifs('trending');
                    }
                }, 500));
            }
        });

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        async function searchGifs(query) {
            const gifResults = document.getElementById('gif-results');
            if (!gifResults) return;

            try {
                const endpoint = query === 'trending' 
                    ? `https://api.giphy.com/v1/gifs/trending?api_key=${GIPHY_API_KEY}&limit=20`
                    : `https://api.giphy.com/v1/gifs/search?api_key=${GIPHY_API_KEY}&q=${query}&limit=20`;
                
                const response = await fetch(endpoint);
                const data = await response.json();
                
                gifResults.innerHTML = '';
                data.data.forEach(gif => {
                    const img = document.createElement('img');
                    img.src = gif.images.fixed_height_small.url;
                    img.style.cursor = 'pointer';
                    img.style.width = '100%';
                    img.style.height = 'auto';
                    img.onclick = () => selectGif(gif.images.fixed_height.url);
                    gifResults.appendChild(img);
                });
            } catch (error) {
                console.error('Error fetching GIFs:', error);
            }
        }

        async function selectGif(gifUrl) {
            console.log('selectGif called with URL:', gifUrl); // Log the GIF URL

            const gifModal = document.getElementById('gif-modal');
            const now = Date.now();
            
            // Cooldown check
            if (now - lastGifTime < GIF_COOLDOWN) {
                const remainingTime = Math.ceil((GIF_COOLDOWN - (now - lastGifTime)) / 1000);
                alert(`Please wait ${remainingTime} seconds before sending another GIF`);
                return;
            }

            const currentUser = firebase.auth().currentUser;
            if (!currentUser) {
                console.error('No current user found');
                alert('You must be logged in to send a GIF.');
                return;
            }

            try {
                // Get current channel name without the '#' symbol
                const channelTitle = document.getElementById('channel-title').textContent.replace('# ', '');
                console.log('Sending GIF to channel:', channelTitle);

                // Create message data
                const messageData = {
                    userId: currentUser.uid,
                    displayName: currentUser.displayName || 'Anonymous',
                    content: gifUrl,
                    type: 'gif',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                };

                console.log('Message data to be sent:', messageData); // Log the message data

                // Save message in the correct path: channels/{channelId}/messages
                await db.collection('channels').doc(channelTitle).collection('messages').add(messageData);
                console.log('GIF message saved successfully');

                lastGifTime = now;
                if (gifModal) {
                    gifModal.style.display = 'none';
                }
            } catch (error) {
                console.error('Error sending GIF:', error);
                alert('Failed to send GIF. Please try again.');
            }
        }

        // Object to keep track of unread messages for each channel
        let unreadMessages = {};

// Function to load channels that the user has joined
async function loadJoinedChannels(userId) {
    const channelsList = document.getElementById('channels-list');
    console.log('Loading channels for user:', userId); // Debug log

    // Fetch user data to get the list of joined channels
    const userDoc = await db.collection('users').doc(userId).get();
    if (userDoc.exists) {
        const userData = userDoc.data();
        const joinedChannels = userData.channels || []; // Reference the channels array
        console.log('Joined channels:', joinedChannels); // Debug log

        // Check if the joinedChannels array is empty
        if (joinedChannels.length === 0) {
            channelsList.innerHTML = '<li>No channels joined.</li>'; // Inform the user
            return; // Exit the function
        }

        // Set up a real-time listener for the channels
        const channelsRef = db.collection('channels').where(firebase.firestore.FieldPath.documentId(), 'in', joinedChannels);
        channelsRef.onSnapshot((channelsSnapshot) => {
            // Clear the channels list before adding new ones
            channelsList.innerHTML = '';

            // Only add channels that are not already in the list
            channelsSnapshot.forEach(doc => {
                const channelId = doc.id;
                const channelData = doc.data();
                const channelName = channelData.name || channelId;
                console.log('Channel loaded:', channelName); // Debug log

                // Create a list item for the channel
                const listItem = document.createElement('li');
                listItem.id = `channel-${channelId}`; // Unique ID for the channel
                listItem.innerHTML = `
                    <span class="channel-name" onclick="joinChannel('${channelId}')">${channelName}</span>
                    <span class="unread-count" id="unread-${channelId}" style="display: none; background: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.8rem; margin-left: 5px;"></span>
                `;
                channelsList.appendChild(listItem);
            });
        }, (error) => {
            console.error('Error fetching channels:', error);
            alert('Failed to load channels. Please try again later.');
        });
    } else {
        console.log('User document does not exist.'); // Debug log
    }
}
        // Function to join a channel
        function joinChannel(channelId) {
            // Reset unread messages count when joining the channel
            unreadMessages[channelId] = 0;
            updateUnreadCount(channelId);

            // Load messages for the selected channel
            loadChannelMessages(channelId);
        }

        // Function to update unread message count display
        function updateUnreadCount(channelId) {
            const unreadCountElement = document.getElementById(`unread-${channelId}`);
            if (unreadCountElement) { // Check if the element exists
                if (unreadMessages[channelId] > 0) {
                    unreadCountElement.textContent = unreadMessages[channelId];
                    unreadCountElement.style.display = 'inline';
                } else {
                    unreadCountElement.style.display = 'none';
                }
            }
        }

        // Modify the message listener to track unread messages
        function setupMessageListener() {
            const channelTitle = document.getElementById('channel-title').textContent.replace('# ', '');
            console.log('Setting up message listener for channel:', channelTitle);

            // Set up real-time listener for messages in the specific channel
            return db.collection('channels').doc(channelTitle).collection('messages')
                .orderBy('timestamp', 'asc')  // Ensure messages are in order
                .onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            const message = change.doc.data();
                            console.log('Processing message:', message);
                            displayMessage(message);

                            // Check if the current channel is not the one receiving the message
                            if (channelTitle !== message.channelId) {
                                // Increment unread message count for the channel
                                unreadMessages[message.channelId] = (unreadMessages[message.channelId] || 0) + 1;
                                updateUnreadCount(message.channelId);
                            }
                        }
                    });
                }, (error) => {
                    console.error('Error in message listener:', error);
                });
        }

        // Function to display a single message
        function displayMessage(message) {
            const messagesContainer = document.getElementById('messages');
            const messageElement = document.createElement('div');
            messageElement.className = 'message';

            const currentUser = firebase.auth().currentUser;
            const isAdmin = currentUser && currentUser.admin; // Check if the user is an admin

            console.log('Current User:', currentUser);
            console.log('Is Admin:', isAdmin);

            messageElement.innerHTML = `
                <div class="message-header">
                    <strong>${message.displayName}</strong>
                    <span class="timestamp">${message.timestamp ? new Date(message.timestamp.toDate()).toLocaleString() : 'Just now'}</span>
                    ${isAdmin ? `<button class="pin-message-btn" onclick="pinMessage('${message.id}')">üìå</button>` : ''}
                </div>
                <div class="message-content">
                    ${message.content}
                </div>
            `;

            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight; // Scroll to the bottom
        }

        // Call loadJoinedChannels when the page loads
        window.addEventListener('load', () => {
            const userId = firebase.auth().currentUser.uid; // Get the current user's ID
            loadJoinedChannels(userId);
            // Set up the message listener for the currently selected channel
            setupMessageListener();
        });

        // Function to update the user's bio
        document.getElementById('update-bio-btn').addEventListener('click', async () => {
            const currentUser = firebase.auth().currentUser; // Get the currently authenticated user
            if (!currentUser) return; // Exit if no user is authenticated

            const newBio = document.getElementById('bio-input').value.trim(); // Get the new bio from input
            if (newBio === '') {
                alert('Bio cannot be empty.'); // Alert if the bio is empty
                return;
            }

            try {
                // Update the user's bio in Firestore
                await db.collection('users').doc(currentUser.uid).update({
                    bio: newBio // Update only the current user's bio
                });

                // Optionally update the displayed bio in the UI
                const bioProfile = document.getElementById('profile-modal-bio');
                if (bioProfile) {
                    bioProfile.innerHTML = `<span style="color: #1E90FF;">${newBio}</span>`; // Update the displayed bio
                }

                alert('Bio updated successfully!'); // Alert on success
            } catch (error) {
                console.error('Error updating bio:', error); // Log the error for debugging
                alert('Failed to update bio. Please try again.'); // Alert on failure
            }
        });

        // Function to load user data and display the bio and status
        async function loadUserData(userId) {
            // Wait for db to be ready
            function waitForDbInLoadUserData() {
                if (typeof db !== 'undefined') {
                    db.collection('users').doc(userId).get()
                        .then(userDoc => {
                            if (userDoc.exists) {
                                const userData = userDoc.data();
                                document.getElementById('user-name').textContent = userData.displayName;
                                document.getElementById('user-avatar').src = userData.photoURL || 'assets/icon.png';
                                document.getElementById('bio-input').value = userData.bio || 'No Bio'; // Set initial bio value
                                document.getElementById('profile-modal-bio').innerHTML = userData.bio ? `<span style="color: #1E90FF;">${userData.bio}</span>` : 'No bio available'; // Display bio in profile modal
                            }
                        }).catch(error => {
                            console.error('Error loading user data:', error);
                        });
                    } else {
                        setTimeout(waitForDbInLoadUserData, 100);
                    }
                }

                waitForDbInLoadUserData();
            }
        }

        // Call loadUserData when the user is authenticated
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                const userId = user.uid;

                // Wait for db to be ready before loading user data
                function waitForDbForUserData() {
                    if (typeof db !== 'undefined') {
                        loadUserData(userId);
                    } else {
                        setTimeout(waitForDbForUserData, 100);
                    }
                }

                waitForDbForUserData();
            }
        });

        // Add event listener for updating status
        document.getElementById('update-status-btn').addEventListener('click', async () => {
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) return;

            const selectedStatus = document.getElementById('status-select').value;
            if (selectedStatus === '') {
                alert('Please select a status.');
                return;
            }

            try {
                // Update user's status in Firestore
                await db.collection('users').doc(currentUser.uid).update({
                    status: selectedStatus
                });

                alert('Status updated successfully!');
                loadFriends(currentUser.uid); // Reload friends to reflect the new status
            } catch (error) {
                console.error('Error updating status:', error);
                alert('Failed to update status. Please try again.');
            }
        });

        // Open Friends Modal
        document.getElementById('open-friends-modal').addEventListener('click', () => {
            document.getElementById('friends-modal').style.display = 'block';
            loadFriends(firebase.auth().currentUser.uid); // Load friends when modal opens
        });

        // Close Friends Modal
        document.getElementById('close-friends-modal').addEventListener('click', () => {
            document.getElementById('friends-modal').style.display = 'none';
        });

        async function pinMessage(messageId) {
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) return;

            try {
                // Update the message in Firestore to mark it as pinned
                await db.collection('channels').doc(currentChannelId).collection('messages').doc(messageId).update({
                    pinned: true
                });

                alert('Message pinned successfully!');
                // Optionally, refresh the messages to show the pinned message at the top
                loadChannelMessages(currentChannelId);
            } catch (error) {
                console.error('Error pinning message:', error);
                alert('Failed to pin message. Please try again.');
            }
        }

        async function loadChannelMessages(channelId) {
            const messagesContainer = document.getElementById('messages');
            messagesContainer.innerHTML = ''; // Clear previous messages

            // Fetch messages from Firestore
            const messagesSnapshot = await db.collection('channels').doc(channelId).collection('messages')
                .orderBy('timestamp', 'asc').get();

            // Display pinned messages first
            messagesSnapshot.forEach(doc => {
                const message = { id: doc.id, ...doc.data() };
                if (message.pinned) {
                    displayMessage(message); // Display pinned messages
                }
            });

            // Then display regular messages
            messagesSnapshot.forEach(doc => {
                const message = { id: doc.id, ...doc.data() };
                if (!message.pinned) {
                    displayMessage(message); // Display regular messages
                }
            });
        }

        // Handle confirmation of image change
        document.getElementById('confirm-image-change-btn').addEventListener('click', async () => {
            const currentUser = firebase.auth().currentUser;
            const fileInput = document.getElementById('profile-image-input');
            const file = fileInput.files[0];

            if (file) {
                try {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const base64Image = e.target.result;

                        // Update user's photoURL in Firestore with base64 string
                        await db.collection('users').doc(currentUser.uid).update({
                            photoURL: base64Image
                        });

                        // Update all UI elements showing the user's avatar
                        const avatarElements = document.querySelectorAll(`img[src="${document.getElementById('user-avatar').src}"]`);
                        avatarElements.forEach(element => {
                            element.src = base64Image;
                        });

                        // Update profile modal image if it exists
                        const profileModalImage = document.getElementById('profile-modal-image');
                        if (profileModalImage) {
                            profileModalImage.src = base64Image;
                        }

                        // Force refresh of friends list to update avatar there
                        loadFriends(currentUser.uid);

                        alert('Profile image updated successfully!');
                        // Close the confirmation modal
                        document.getElementById('confirm-image-change-modal').style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                } catch (error) {
                    console.error('Error updating profile image:', error);
                    alert('Failed to update profile image. Please try again.');
                }
            }
        });

        // Handle cancellation of image change
        document.getElementById('cancel-image-change-btn').addEventListener('click', () => {
            document.getElementById('confirm-image-change-modal').style.display = 'none'; // Close the modal
        });

        // Close the confirmation modal when the close button is clicked
        document.getElementById('close-confirm-image-change-modal').addEventListener('click', () => {
            document.getElementById('confirm-image-change-modal').style.display = 'none'; // Close the modal
        });
   
    </script>

    <!-- Suggestions Modal -->
    <div id="suggestions-modal" class="modal" inert aria-labelledby="suggestions-modal-title">
        <div class="modal-content">
            <button id="close-suggestions-modal" class="close-button" aria-label="Close Suggestions Modal">&times;</button>
            <h2 id="suggestions-modal-title">Submit Your Suggestions</h2>
            <iframe src="https://docs.google.com/forms/d/13N4gBgbZOyxgNzUuc8OHCVXlJ6j81BaS7wG-ZRQKbj0/viewform?embedded=true" width="100%" height="500" frameborder="0" marginheight="0" marginwidth="0">Loading‚Ä¶</iframe>
        </div>
    </div>


</body>
</html>