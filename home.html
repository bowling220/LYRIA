<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>LYRIA Chat - Home</title>
        
        <!-- Meta Tags for Educational Purpose -->
        <meta name="description" content="LYRIA Chat is an educational platform designed to facilitate communication and collaboration among students and educators.">
        <meta name="keywords" content="education, chat, communication, students, teachers, learning, collaboration">
        <meta name="author" content="Bowling220 & TurquoiseBrush">
        <meta name="robots" content="index, follow">
        <meta name="theme-color" content="#5865f2"> <!-- Optional: Sets the theme color for mobile browsers -->
    
        <link rel="stylesheet" href="style.css">
        <link rel="stylesheet" href="chat.css">
        <link rel="stylesheet" href="voiceCall.css">
        
        <!-- Firebase SDKs -->
        <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
        
        <!-- PeerJS and Agora RTC SDK -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.3.1/peerjs.min.js"></script>
        <script src="https://cdn.agora.io/sdk/release/AgoraRTC_N.js"></script>
    </head>
<body>
    <!-- Mobile Experience Message -->
    <div id="mobile-message" style="display: none; background-color: #ffcccb; padding: 10px; text-align: center; position: sticky; top: 0; z-index: 1000;">
        For a better experience, please use a computer.
        <button id="close-mobile-message" style="margin-left: 10px; background-color: #f44336; color: white; border: none; cursor: pointer;">
            Close
        </button>
    </div>

    <header class="top-header">
        <button class="menu-toggle">☰</button>
        <span style="flex: 1; text-align: center;">LYRIA Chat</span>
    </header>
    <div class="app-container">
        <button class="menu-toggle" id="sidebar-menu-toggle">☰</button>
        <div class="sidebar">
            <div class="channels">
                <h3>Channels</h3>
                <ul class="channels-list" id="channels-list"></ul>
                <button class="add-channel-btn" id="add-channel">Add Channel</button>
                <button class="join-channel-btn" id="join-channel">Join Channel</button>
                <button class="leave-channel-btn" id="leave-channel">Leave Channel</button>
            </div>

            <!-- Friends Section -->
            <div class="friends-section">
                <h3>Friends</h3>
                <ul class="friends-list" id="friends-list">
                    Add Some Friends!
                </ul>
            </div>

            <!-- Suggestions Section -->
            <div class="suggestions-section">
                <h3>Suggestions</h3>
                <p>We value your feedback! Please share your suggestions for new features or improvements.</p>
                <button id="open-suggestions-modal" class="suggestions-link">Submit Your Suggestions</button>
            </div>

            <div class="user-profile">
                <img class="avatar" id="user-avatar" src="assets/icon.png" alt="User avatar">
                <span class="username" id="user-name">User</span>
                <button class="settings-btn" id="settings-btn">Settings</button>
            </div>

        </div>
        <main class="chat-area">
            <header class="chat-header">
                <h2 id="channel-title"># general</h2>
                <button id="copy-join-code" class="copy-join-code-btn">Invite Others</button>
                <button id="inbox-btn" onclick="window.location.href='inbox.html'" style="background: none; border: none; color: var(--text-color); cursor: pointer; padding: 8px; font-size: 1.2rem;">
                    📬 Inbox <span id="friend-request-count" style="background: red; color: white; padding: 2px 6px; border-radius: 50%; font-size: 0.8rem; display: none;">1</span>
                </button>
            </header>
            <div class="messages" id="messages"></div>
            <!-- Typing Status Indicator -->
            <div id="typing-status" class="typing-status" style="display: none;"></div>
            <div class="message-input">
                <textarea id="message-input" placeholder="Message #" style="height: 15px;"></textarea>
                <button id="send-button" class="send-btn" 
                style="background-color: rgba(255, 255, 255, 0.2); color: rgb(0, 0, 0); border: 1px solid rgba(255, 255, 255, 0.4); padding: 6px 12px; font-size: 14px; cursor: pointer; border-radius: 8px; backdrop-filter: blur(4px);">
                Send
            </button>            </div>
        </main>
    </div>
    <div id="profile-modal">
        <div class="modal-content">
            <img id="profile-modal-image" src="assets/icon.png" alt="User Avatar">
            <h2 id="profile-modal-name">User Name</h2>
            <div id="profile-modal-badges" class="badges-container"></div>
            <p id="profile-modal-bio">COMING SOON</p>
            <button id="send-friend-request" class="action-btn">Send Friend Request</button>
            <button id="close-profile-modal">Close</button>
        </div>
    </div>
<div id="version-info" style="position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); color: var(--text-color); font-size: 12px; font-weight: bold; text-shadow: 1px 1px 2px var(--background-color);">
    Version: Beta 3.0.0 &copy; 2024 LYRIA. All rights reserved. Trademarked by LYRIA.
</div>
<!-- Settings Modal -->
<div id="settings-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="settings-modal-title">
    <div class="modal-content">
        <button id="close-modal" class="close-button" aria-label="Close Settings Modal">&times;</button>
        <h2 id="settings-modal-title">Settings</h2>
        
        <!-- Toggle Dark Mode -->
        <div class="modal-section">
            <button id="toggle-dark-mode" class="action-btn">Toggle Dark Mode</button>
        </div>
        
        <!-- Update Profile Image -->
        <div class="modal-section">
            <label for="profile-image-input" class="modal-label">Update Profile Image:</label>
            <input type="file" id="profile-image-input" class="modal-input" accept="image/*" disabled>
            <button id="update-profile-image" class="action-btn" disabled>Update Image (Premium)</button>
            <p class="premium-info" style="color: #ffcc00;">Premium users can change their profile picture.</p>
        </div>

        <!-- Upgrade to Premium Section -->
        <div class="modal-section">
            <button id="upgrade-to-premium" class="action-btn upgrade-btn">👑 Upgrade to Premium</button>
            <p style="color: #ffcc00;">Unlock premium features by upgrading your account!</p>
        </div>

        <!-- Update Display Name -->
        <div class="modal-section">
            <label for="display-name-input" class="modal-label">Update Display Name:</label>
            <input type="text" id="display-name-input" class="modal-input" placeholder="Enter new display name">
            <button id="update-display-name" class="action-btn">Update Name</button>
        </div>
        
        <!-- Update Bio Section -->
        <div class="modal-section">
            <label for="bio-input" class="modal-label">Update Bio:</label>
            <input type="text" id="bio-input" class="modal-input" placeholder="Coming Soon" disabled>
            <div class="tooltip-container">
                <button id="update-bio-btn" class="action-btn update-bio-btn" disabled>Update Bio</button>
                <span class="tooltip">Coming Soon</span>
            </div>
            <p class="premium-info" style="color: #ffcc00;">This feature is currently coming soon.</p>
        </div>
        
        <!-- Enable Notifications -->
        <div class="modal-section">
            <label class="toggle-switch">
                <input type="checkbox" id="notifications-toggle">
                <span class="slider"></span>
                Enable Notifications
            </label>
        </div>
        
        <!-- Toggle Badge Visibility (only visible if user has the admin badge) -->
        <div class="modal-section" id="badge-visibility-section" style="display: none;">
            <label class="toggle-switch">
                <input type="checkbox" id="badge-visibility-toggle">
                <span class="slider"></span>
                Show Badges
            </label>
        </div>
        
        <!-- Logout Button -->
        <div class="modal-section">
            <button id="logout-btn" class="action-btn logout-btn">Logout</button>
        </div>
    </div>
</div>

    <!-- Include voicecall.js before chat.js -->
    <script src="voicecall.js"></script>
    <script src="chat.js"></script>

    <script>
        // Detect if the user is on a mobile device
        function isMobileDevice() {
            return /Mobi|Android|iPhone|iPad|iPod|Windows Phone/i.test(navigator.userAgent);
        }

        // Display the mobile message if on a mobile device
        window.addEventListener('load', () => {
            const mobileMessage = document.getElementById('mobile-message');
            if (isMobileDevice()) {
                mobileMessage.style.display = 'block';
            }

            // Load last visited channel from localStorage
            const lastChannel = localStorage.getItem('lastVisitedChannel');
            if (lastChannel) {
                // Update channel title and load messages for last visited channel
                document.getElementById('channel-title').textContent = `# ${lastChannel}`;
                // Assuming you have a function to load channel messages
                loadChannelMessages(lastChannel);
            }
        });

        // Close the mobile message
        document.getElementById('close-mobile-message').addEventListener('click', () => {
            const mobileMessage = document.getElementById('mobile-message');
            mobileMessage.style.display = 'none';
        });

        // Assuming you have already initialized Firebase and authenticated the user
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                const userId = user.uid;

                // Fetch user data from Firestore
                db.collection('users').doc(userId).get().then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        document.getElementById('user-name').textContent = userData.displayName;
                        document.getElementById('user-avatar').src = userData.photoURL || 'assets/icon.png';

                        // Set initial values for settings
                        document.getElementById('notifications-toggle').checked = userData.notificationsEnabled || false;
                        document.getElementById('bio-input').value = 'COMING SOON';
                        document.getElementById('profile-modal-bio').textContent = 'COMING SOON';

                        // Set dark mode based on user preference
                        if (userData.darkMode) {
                            document.body.classList.add('dark-mode');
                        }

                        // Load friends
                        loadFriends(userId);
                        
                        // Check for friend requests
                        checkFriendRequests(userId);

                        // Check if user is premium and unlock features
                        if (userData.isPremium) {
                            // Enable premium features
                            document.getElementById('profile-image-input').disabled = false;
                            document.getElementById('update-profile-image').disabled = false;
                            document.getElementById('bio-input').disabled = false;
                            document.getElementById('update-bio-btn').disabled = false;
                        }
                    } else {
                        console.log("No such document!");
                    }
                }).catch(error => {
                    console.error("Error getting document:", error);
                });
            }
        });

        // Function to check for friend requests
        function checkFriendRequests(userId) {
            db.collection('friendRequests')
                .where('to', '==', userId)
                .onSnapshot(snapshot => {
                    const requestCount = snapshot.docs.length;
                    const countElement = document.getElementById('friend-request-count');
                    if (requestCount > 0) {
                        countElement.style.display = 'inline';
                        countElement.textContent = requestCount;
                    } else {
                        countElement.style.display = 'none';
                    }
                });
        }

        // Function to remove friend
        async function removeFriend(friendId) {
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) return;

            try {
                // Remove friend from current user's friends list
                await db.collection('users').doc(currentUser.uid).update({
                    friends: firebase.firestore.FieldValue.arrayRemove(friendId)
                });

                // Remove current user from friend's friends list
                await db.collection('users').doc(friendId).update({
                    friends: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
                });

                // Reload friends list
                loadFriends(currentUser.uid);
            } catch (error) {
                console.error('Error removing friend:', error);
                alert('Failed to remove friend. Please try again.');
            }
        }

        // Function to load friends with images and names
        async function loadFriends(userId) {
            const friendsList = document.getElementById('friends-list');
            friendsList.innerHTML = ''; // Clear previous content

            try {
                // Get the current user's document
                const userDoc = await db.collection('users').doc(userId).get();

                if (userDoc.exists) {
                    const userData = userDoc.data();
                    const friends = userData.friends || []; // Get the friends array

                    if (friends.length === 0) {
                        friendsList.innerHTML = '<li>No friends added yet.</li>';
                        return;
                    }

                    // Loop through each friend's ID
                    for (const friendId of friends) {
                        // Fetch friend's details from the users collection
                        const friendDoc = await db.collection('users').doc(friendId).get();
                        if (friendDoc.exists) {
                            const friendData = friendDoc.data();
                            const friendName = friendData.displayName || 'Unknown Friend';
                            const friendAvatar = friendData.photoURL || 'default-avatar.png';

                            // Add the friend's information to the list with remove button
                            const listItem = document.createElement('li');
                            listItem.innerHTML = `
                                <img src="${friendAvatar}" alt="${friendName}" class="friend-avatar">
                                <span class="friend-name">${friendName}</span>
                                <button onclick="removeFriend('${friendId}')" class="remove-friend-btn" style="margin-left: auto; background: none; border: none; color: #ff4444; cursor: pointer;">
                                    ❌
                                </button>
                            `;
                            listItem.style.display = 'flex';
                            listItem.style.alignItems = 'center';
                            listItem.style.justifyContent = 'space-between';
                            friendsList.appendChild(listItem);
                        }
                    }
                } else {
                    friendsList.innerHTML = '<li>No user data found.</li>';
                }
            } catch (error) {
                console.error('Error loading friends:', error);
                friendsList.innerHTML = '<li>Failed to load friends.</li>';
            }
        }

        async function acceptFriendRequest(requestId) {
            const requestDoc = await db.collection('friendRequests').doc(requestId).get();
            if (requestDoc.exists) {
                const requestData = requestDoc.data();
                const currentUser = firebase.auth().currentUser;

                // Update both users' friends arrays
                await db.collection('users').doc(currentUser.uid).update({
                    friends: firebase.firestore.FieldValue.arrayUnion(requestData.from)
                });
                await db.collection('users').doc(requestData.from).update({
                    friends: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                });

                // Remove the friend request
                await db.collection('friendRequests').doc(requestId).delete();

                alert('Friend request accepted!');
            }
        }

        // Add event listener for profile image update
        document.getElementById('update-profile-image').addEventListener('click', async () => {
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) return;

            try {
                // Fetch user data from Firestore
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (!userDoc.exists) {
                    console.error("User document does not exist.");
                    return;
                }

                const userData = userDoc.data();
                
                // Check if the user is premium
                if (!userData.isPremium) {
                    alert('This feature is only available to premium users. Please upgrade your account to change your profile picture.');
                    return;
                }

                const fileInput = document.getElementById('profile-image-input');
                const file = fileInput.files[0];

                if (file) {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const base64Image = e.target.result;

                        // Update user's photoURL in Firestore with base64 string
                        await db.collection('users').doc(currentUser.uid).update({
                            photoURL: base64Image
                        });

                        // Update all UI elements showing the user's avatar
                        const avatarElements = document.querySelectorAll(`img[src="${document.getElementById('user-avatar').src}"]`);
                        avatarElements.forEach(element => {
                            element.src = base64Image;
                        });

                        // Update profile modal image if it exists
                        const profileModalImage = document.getElementById('profile-modal-image');
                        if (profileModalImage) {
                            profileModalImage.src = base64Image;
                        }

                        // Force refresh of friends list to update avatar there
                        loadFriends(currentUser.uid);

                        alert('Profile image updated successfully!');
                    };
                    reader.readAsDataURL(file);
                } else {
                    alert('Please select an image file first.');
                }
            } catch (error) {
                console.error('Error updating profile image:', error);
                alert('Failed to update profile image. Please try again.');
            }
        });

        // Add event listener for the upgrade to premium button
        document.getElementById('upgrade-to-premium').addEventListener('click', () => {
            // Redirect to a payment page or show a modal for payment options
            window.location.href = 'premium-upgrade.html'; // Replace with your actual upgrade page
        });

        // Save current channel before leaving
        window.addEventListener('beforeunload', () => {
            const currentChannel = document.getElementById('channel-title').textContent.replace('# ', '');
            localStorage.setItem('lastVisitedChannel', currentChannel);
        });
    </script>

    <!-- Suggestions Modal -->
    <div id="suggestions-modal" class="modal" inert aria-labelledby="suggestions-modal-title">
        <div class="modal-content">
            <button id="close-suggestions-modal" class="close-button" aria-label="Close Suggestions Modal">&times;</button>
            <h2 id="suggestions-modal-title">Submit Your Suggestions</h2>
            <iframe src="https://docs.google.com/forms/d/13N4gBgbZOyxgNzUuc8OHCVXlJ6j81BaS7wG-ZRQKbj0/viewform?embedded=true" width="100%" height="500" frameborder="0" marginheight="0" marginwidth="0">Loading…</iframe>
        </div>
    </div>

    <!-- Overlay for the badge preview modal -->


</body>
</html>