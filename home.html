<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LYRIA Chat</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <style>
    .join-channel-btn {
      background: #7289da;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.2s;
      margin-top: 8px;
      width: 100%;
    }

    .join-channel-btn:hover {
      background: #5b73c7;
    }

    .copy-join-code-btn {
      background: #43b581;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .copy-join-code-btn:hover {
      background: #3ca374;
      transform: translateY(-1px);
    }

    .copy-join-code-btn:active {
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <header class="top-header"><h1>LYRIA</h1></header>
  <div class="app-container">
    <nav class="sidebar">
      <div class="user-profile">
        <img class="avatar" id="user-avatar" src="https://via.placeholder.com/40" alt="User avatar">
        <span class="username" id="user-name">Username</span>
        <button class="settings-btn" id="settings-btn">Settings</button>
      </div>
      <div class="channels">
        <h3>Channels</h3>
        <ul class="channels-list" id="channels-list"></ul>
        <button class="add-channel-btn" id="add-channel">+ Add Channel</button>
        <button class="join-channel-btn" id="join-channel">Join Channel by Code</button>
      </div>
    </nav>
    <main class="chat-area">
      <header class="chat-header">
        <h2 id="channel-title"># general</h2>
        <button id="copy-join-code" class="copy-join-code-btn">Copy Join Code</button>
      </header>
      <div class="messages" id="messages"></div>
      <div class="message-input">
        <textarea id="message-input" placeholder="Type your message..."></textarea>
        <button id="send-button" class="send-btn">Send</button>
      </div>
    </main>
    <aside class="users-sidebar">
      <h3>Online Users</h3>
      <ul id="users-list" class="users-list"></ul>
    </aside>
  </div>
 
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDORsM0Dz9d_ZxqVd8zjNXwsEdR1_aVF7g",
      authDomain: "lyria-cfc06.firebaseapp.com",
      projectId: "lyria-cfc06",
      storageBucket: "lyria-cfc06.appspot.com",
      messagingSenderId: "309881717815",
      appId: "1:309881717815:web:c8e9a4007341ab17ecebb2",
      measurementId: "G-0EMBBE255Z"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
 
    let currentUser;
    let currentChannel;

    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        loadUserData();
        loadUserChannels();
        updateOnlineStatus(true);
        loadSavedChannel();
      } else {
        window.location.href = 'index.html';
      }
    });

    function loadSavedChannel() {
      const userDocRef = db.collection('users').doc(currentUser.uid);
      userDocRef.get().then(doc => {
        if (doc.exists && doc.data().currentChannel) {
          currentChannel = doc.data().currentChannel;
          loadMessages(currentChannel);
          loadChannelUsers(currentChannel);
        } else {
          currentChannel = 'general';
          loadMessages(currentChannel);
          loadChannelUsers(currentChannel);
        }
      }).catch(error => console.error("Error loading saved channel:", error));
    }

    function updateOnlineStatus(online) {
      if (currentUser) {
        const userStatusRef = db.collection('users').doc(currentUser.uid);
        userStatusRef.update({
          online: online,
          lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
    }
 
    window.addEventListener('beforeunload', () => {
      updateOnlineStatus(false);
    });
 
    function loadUserData() {
      const userDocRef = db.collection('users').doc(currentUser.uid);
      userDocRef.get().then(doc => {
        if (doc.exists) {
          const data = doc.data();
          document.getElementById('user-name').textContent = data.displayName || 'User';
          document.getElementById('user-avatar').src = data.photoURL || 'https://via.placeholder.com/40';
        }
      }).catch(error => console.error("Error loading user data:", error));
    }
 
    function loadUserChannels() {
  const userDocRef = db.collection('users').doc(currentUser.uid);
  userDocRef.onSnapshot(doc => {
    if (doc.exists) {
      const data = doc.data();
      const channelsList = document.getElementById('channels-list');
      channelsList.innerHTML = ''; // Clear existing channels
      
      if (data.channels && Array.isArray(data.channels)) {
        data.channels.forEach(channel => {
          const li = document.createElement('li');
          const button = document.createElement('button');
          button.className = 'channel-btn';
          button.textContent = `# ${channel.name}`;
          button.onclick = () => {
            loadMessages(channel.id);
            loadChannelUsers(channel.id);
            saveCurrentChannel(channel.id);
          };
          li.appendChild(button);
          channelsList.appendChild(li);
        });
      } else {
        console.warn("No channels found for the user.");
      }
    } else {
      console.error("User document does not exist!");
    }
  }, error => {
    console.error("Error loading channels:", error);
  });
}


    function saveCurrentChannel(channelId) {
      const userDocRef = db.collection('users').doc(currentUser.uid);
      userDocRef.update({
        currentChannel: channelId
      }).catch(error => console.error("Error saving current channel:", error));
    }
 
    function loadChannelUsers(channelId) {
      const usersList = document.getElementById('users-list');
      usersList.innerHTML = '';
     
      db.collection('users').where('channels', 'array-contains', {id: channelId})
        .onSnapshot(snapshot => {
          usersList.innerHTML = '';
          snapshot.forEach(doc => {
            const userData = doc.data();
            const userElement = document.createElement('li');
            userElement.className = 'user-item';
            userElement.innerHTML = `
              <div class="user-info">
                <img class="user-avatar" src="${userData.photoURL || 'https://via.placeholder.com/30'}" alt="${userData.displayName}'s avatar">
                <span class="user-name">${userData.displayName || 'User'}</span>
                <span class="status-indicator ${userData.online ? 'online' : 'offline'}"></span>
              </div>
            `;
            usersList.appendChild(userElement);
          });
        });
    }
 
    function sendMessage() {
      const message = document.getElementById('message-input').value;
      if (message) {
        db.collection('channels').doc(currentChannel).collection('messages').add({
          sender: currentUser.displayName || 'User',
          message,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('message-input').value = '';
      }
    }
 
    function loadMessages(channelId) {
      currentChannel = channelId;
      db.collection('channels').doc(channelId).get().then(doc => {
        if (doc.exists) {
          document.getElementById('channel-title').textContent = `# ${doc.data().name}`;
        }
      });
     
      const messagesContainer = document.getElementById('messages');
      messagesContainer.innerHTML = '';
     
      db.collection('channels').doc(channelId).collection('messages').orderBy('timestamp')
        .onSnapshot(snapshot => {
          messagesContainer.innerHTML = '';
          snapshot.forEach(doc => {
            const data = doc.data();
            const messageElement = document.createElement('div');
            messageElement.className = 'message';
            messageElement.innerHTML = `
              <div class="message-content">
                <span class="sender">${data.sender}</span>
                <p>${data.message}</p>
              </div>`;
            messagesContainer.appendChild(messageElement);
          });
        });
    }

    document.getElementById('send-button').onclick = sendMessage;

    document.getElementById('add-channel').onclick = () => {
      const channelName = prompt('Enter new channel name:');
      if (channelName) {
        const channelId = db.collection('channels').doc().id;
        const channelData = {
          name: channelName,
          joinCode: channelId
        };
 
        db.collection('channels').doc(channelId).set(channelData).then(() => {
          const userDocRef = db.collection('users').doc(currentUser.uid);
          userDocRef.update({
            channels: firebase.firestore.FieldValue.arrayUnion({id: channelId, name: channelName})
          }).catch(error => console.error("Error adding channel to user:", error));
        }).catch(error => console.error("Error creating channel:", error));
      }
    };

    document.getElementById('join-channel').onclick = () => {
      const channelCode = prompt('Enter channel code to join:');
      if (channelCode) {
        db.collection('channels').doc(channelCode).get().then(doc => {
          if (doc.exists) {
            const channelData = doc.data();
            const userDocRef = db.collection('users').doc(currentUser.uid);
            userDocRef.update({
              channels: firebase.firestore.FieldValue.arrayUnion({id: channelCode, name: channelData.name})
            }).then(() => {
              alert(`Successfully joined channel: #${channelData.name}`);
            }).catch(error => console.error("Error joining channel:", error));
          } else {
            alert("Channel code not found. Please check and try again.");
          }
        }).catch(error => console.error("Error finding channel:", error));
      }
    };

    document.getElementById('copy-join-code').onclick = () => {
      navigator.clipboard.writeText(currentChannel).then(() => {
        alert(`Join code copied: ${currentChannel}`);
      }).catch(error => console.error("Error copying join code:", error));
    };

    document.getElementById('settings-btn').onclick = () => {
      window.location.href = 'settings.html';
    };
  </script>
</body>
</html>
