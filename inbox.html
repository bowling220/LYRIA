<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LYRIA Chat - Inbox</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #36393f;
            color: #dcddde;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .top-header {
            background-color: #202225;
            padding: 1rem;
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
            color: #fff;
        }

        .inbox-area {
            padding: 20px;
            background-color: #2f3136;
            height: 100%;
            overflow-y: auto;
        }

        .inbox-message {
            background-color: #32353b;
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .inbox-message div {
            flex: 1;
        }

        .friend-request-actions {
            display: flex;
            gap: 10px;
        }

        .accept-btn, .decline-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .accept-btn {
            background-color: #43b581;
            color: #fff;
        }

        .decline-btn {
            background-color: #e74c3c;
            color: #fff;
        }

        .no-requests {
            text-align: center;
            color: #888;
        }

        .loading {
            text-align: center;
            color: #fff;
        }
    </style>
</head>
<body>
    <header class="top-header">LYRIA Inbox</header>
    <main class="inbox-area" id="inbox-messages">
        <div class="loading">Loading friend requests...</div>
    </main>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "your-api-key",
            authDomain: "your-auth-domain",
            projectId: "your-project-id",
            storageBucket: "your-storage-bucket",
            messagingSenderId: "your-messaging-sender-id",
            appId: "your-app-id"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        /**
         * Load and display friend requests for the logged-in user.
         */
        async function loadFriendRequests() {
            const inboxContainer = document.getElementById("inbox-messages");
            inboxContainer.innerHTML = ""; // Clear previous requests

            try {
                // Check if user is still authenticated
                if (!auth.currentUser) {
                    window.location.href = "login.html";
                    return;
                }

                const currentUser = auth.currentUser;
                const requestsSnapshot = await db.collection("friendRequests")
                    .where("to", "==", currentUser.uid)
                    .get();

                if (requestsSnapshot.empty) {
                    inboxContainer.innerHTML = '<div class="no-requests">No friend requests</div>';
                    return;
                }

                requestsSnapshot.forEach(doc => {
                    const request = doc.data();
                    const messageElement = document.createElement("div");
                    messageElement.className = "inbox-message";

                    // Sender name display
                    const messageText = document.createElement("div");
                    messageText.textContent = `${request.fromName || "Unknown User"} sent you a friend request!`;

                    // Action buttons
                    const actions = document.createElement("div");
                    actions.className = "friend-request-actions";

                    const acceptButton = document.createElement("button");
                    acceptButton.className = "accept-btn";
                    acceptButton.textContent = "Accept";
                    acceptButton.onclick = () => handleFriendRequest(doc.id, "accept", request.from);

                    const declineButton = document.createElement("button");
                    declineButton.className = "decline-btn";
                    declineButton.textContent = "Decline";
                    declineButton.onclick = () => handleFriendRequest(doc.id, "decline", request.from);

                    actions.appendChild(acceptButton);
                    actions.appendChild(declineButton);

                    messageElement.appendChild(messageText);
                    messageElement.appendChild(actions);
                    inboxContainer.appendChild(messageElement);
                });
            } catch (error) {
                console.error("Error loading friend requests:", error);
                inboxContainer.innerHTML = '<div class="no-requests">Error loading friend requests</div>';
            }
        }

        /**
         * Handle friend request actions: accept or decline.
         */
        async function handleFriendRequest(requestId, action, senderId) {
            try {
                // Check if user is still authenticated
                if (!auth.currentUser) {
                    window.location.href = "login.html";
                    return;
                }

                const currentUser = auth.currentUser;

                if (action === "accept") {
                    // Add each other as friends
                    await db.collection("users").doc(currentUser.uid).update({
                        friends: firebase.firestore.FieldValue.arrayUnion(senderId)
                    });

                    await db.collection("users").doc(senderId).update({
                        friends: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                    });

                    alert("Friend request accepted!");
                } else if (action === "decline") {
                    alert("Friend request declined.");
                }

                // Delete the friend request document
                await db.collection("friendRequests").doc(requestId).delete();

                // Refresh requests
                loadFriendRequests();
            } catch (error) {
                console.error("Error handling friend request:", error);
                alert("Error processing request.");
            }
        }

        // Authentication state observer
        auth.onAuthStateChanged(user => {
            if (user) {
                loadFriendRequests(); // Load requests for the logged-in user
            } else {
                window.location.href = "login.html"; // Redirect to login if not authenticated
            }
        });
    </script>
</body>
</html>
