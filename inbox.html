<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LYRIA Chat - Inbox</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #36393f;
            color: #dcddde;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .top-header {
            background-color: #202225;
            padding: 1rem;
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
            color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .back-btn {
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;
            font-size: 1rem;
            padding: 5px 10px;
        }

        .inbox-area {
            padding: 20px;
            background-color: #2f3136;
            height: 100%;
            overflow-y: auto;
        }

        .inbox-message {
            background-color: #32353b;
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .inbox-message:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .inbox-message div {
            flex: 1;
        }

        .friend-request-actions {
            display: flex;
            gap: 10px;
        }

        .accept-btn, .decline-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .accept-btn {
            background-color: #43b581;
            color: #fff;
        }

        .accept-btn:hover {
            background-color: #3ca374;
            transform: scale(1.05);
        }

        .decline-btn {
            background-color: #e74c3c;
            color: #fff;
        }

        .decline-btn:hover {
            background-color: #d44232;
            transform: scale(1.05);
        }

        .no-requests {
            text-align: center;
            color: #888;
            padding: 2rem;
            font-size: 1.1rem;
        }

        .loading {
            text-align: center;
            color: #fff;
            padding: 2rem;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(5, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .error-message {
            background-color: #f0506e;
            color: white;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <header class="top-header">
        <button class="back-btn" onclick="window.history.back()">‚Üê</button>
        <span>LYRIA Inbox</span>
        <div style="width: 30px"></div>
    </header>
    <main class="inbox-area" id="inbox-messages">
        <div class="loading">Loading friend requests</div>
    </main>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "your-api-key",
            authDomain: "your-auth-domain",
            projectId: "your-project-id",
            storageBucket: "your-storage-bucket",
            messagingSenderId: "your-messaging-sender-id",
            appId: "your-app-id"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        /**
         * Load and display friend requests for the logged-in user.
         */
        async function loadFriendRequests() {
            const inboxContainer = document.getElementById("inbox-messages");
            inboxContainer.innerHTML = '<div class="loading">Loading friend requests</div>';

            try {
                // Get the user ID from URL parameter
                const urlParams = new URLSearchParams(window.location.search);
                const userId = urlParams.get('userId');

                if (!userId) {
                    showError("No user ID specified. Please log in again.");
                    return;
                }

                // Real-time listener for friend requests
                const unsubscribe = db.collection("friendRequests")
                    .where("to", "==", userId)
                    .onSnapshot(async (snapshot) => {
                        inboxContainer.innerHTML = "";
                        
                        if (snapshot.empty) {
                            inboxContainer.innerHTML = '<div class="no-requests">No friend requests at the moment</div>';
                            return;
                        }

                        const requests = [];
                        for (const doc of snapshot.docs) {
                            const request = doc.data();
                            // Fetch sender's latest profile info
                            try {
                                const senderDoc = await db.collection("users").doc(request.from).get();
                                const senderData = senderDoc.data();
                                request.fromName = senderData?.displayName || "Unknown User";
                            } catch (error) {
                                console.error("Error fetching sender data:", error);
                                request.fromName = "Unknown User";
                            }
                            requests.push({ id: doc.id, ...request });
                        }

                        requests.forEach(request => {
                            const messageElement = document.createElement("div");
                            messageElement.className = "inbox-message";

                            const messageText = document.createElement("div");
                            messageText.textContent = `${request.fromName} sent you a friend request!`;

                            const actions = document.createElement("div");
                            actions.className = "friend-request-actions";

                            const acceptButton = document.createElement("button");
                            acceptButton.className = "accept-btn";
                            acceptButton.textContent = "Accept";
                            acceptButton.onclick = () => handleFriendRequest(request.id, "accept", request.from, userId);

                            const declineButton = document.createElement("button");
                            declineButton.className = "decline-btn";
                            declineButton.textContent = "Decline";
                            declineButton.onclick = () => handleFriendRequest(request.id, "decline", request.from, userId);

                            actions.appendChild(acceptButton);
                            actions.appendChild(declineButton);

                            messageElement.appendChild(messageText);
                            messageElement.appendChild(actions);
                            inboxContainer.appendChild(messageElement);
                        });
                    }, error => {
                        console.error("Error in real-time listener:", error);
                        showError("Error loading friend requests. Please refresh the page.");
                    });

                // Clean up listener when page is closed
                window.addEventListener('unload', () => unsubscribe());

            } catch (error) {
                console.error("Error loading friend requests:", error);
                showError("Error loading friend requests. Please try again later.");
            }
        }

        /**
         * Display error message to user
         * @param {string} message - Error message to display
         */
        function showError(message) {
            const inboxContainer = document.getElementById("inbox-messages");
            inboxContainer.innerHTML = `<div class="error-message">${message}</div>`;
        }

        /**
         * Handle friend request actions: accept or decline.
         * @param {string} requestId - The ID of the friend request document
         * @param {string} action - The action to take ('accept' or 'decline')
         * @param {string} senderId - The user ID of the friend request sender
         * @param {string} userId - The user ID of the request recipient
         */
        async function handleFriendRequest(requestId, action, senderId, userId) {
            const actionButtons = document.querySelectorAll(`button[onclick*="${requestId}"]`);
            actionButtons.forEach(btn => btn.disabled = true);

            try {
                if (action === "accept") {
                    // Start a batch write
                    const batch = db.batch();
                    
                    // Add each other as friends
                    batch.update(db.collection("users").doc(userId), {
                        friends: firebase.firestore.FieldValue.arrayUnion(senderId),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    batch.update(db.collection("users").doc(senderId), {
                        friends: firebase.firestore.FieldValue.arrayUnion(userId),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // Delete the friend request
                    batch.delete(db.collection("friendRequests").doc(requestId));

                    // Commit the batch
                    await batch.commit();

                    // Create notification for sender
                    await db.collection("notifications").add({
                        userId: senderId,
                        type: "friend_request_accepted",
                        message: "Your friend request was accepted!",
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        read: false
                    });

                } else if (action === "decline") {
                    await db.collection("friendRequests").doc(requestId).delete();
                }

            } catch (error) {
                console.error("Error handling friend request:", error);
                showError("Error processing request. Please try again.");
                actionButtons.forEach(btn => btn.disabled = false);
            }
        }

        // Load friend requests when page loads
        document.addEventListener('DOMContentLoaded', loadFriendRequests);
    </script>
</body>
</html>
